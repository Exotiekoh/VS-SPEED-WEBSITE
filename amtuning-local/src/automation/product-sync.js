// VSSPEED GLOBAL - Product Database Sync
// This module syncs scraped products into the local product database

import { products as currentProducts } from '../data/productDatabase.js';

/**
 * Syncs scraped products into the product database
 * @param {Array} scrapedProducts - Products from supplier scraper
 * @returns {Object} Sync results with counts
 */
export const syncProductsToDatabase = (scrapedProducts) => {
    console.log(`üîÑ Syncing ${scrapedProducts.length} products to database...`);
    
    let added = 0;
    let updated = 0;
    let skipped = 0;
    
    const updatedDatabase = [...currentProducts];
    
    scrapedProducts.forEach(scrapedProduct => {
        const existingIndex = updatedDatabase.findIndex(
            p => p.id === scrapedProduct.id
        );
        
        if (existingIndex >= 0) {
            // Update existing product
            updatedDatabase[existingIndex] = {
                ...updatedDatabase[existingIndex],
                ...scrapedProduct,
                updatedAt: new Date().toISOString()
            };
            updated++;
        } else {
            // Add new product
            updatedDatabase.push({
                ...scrapedProduct,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            added++;
        }
    });
    
    const results = {
        total: scrapedProducts.length,
        added,
        updated,
        skipped,
        newDatabaseSize: updatedDatabase.length
    };
    
    console.log(`‚úÖ Sync complete: ${added} added, ${updated} updated, ${skipped} skipped`);
    console.log(`   Total products in database: ${updatedDatabase.length}`);
    
    return {
        results,
        updatedDatabase
    };
};

/**
 * Generates the productDatabase.js file content
 */
export const generateDatabaseFile = (products) => {
    const fileContent = `// VSSPEED GLOBAL - Product Database
// Auto-generated by automation system on ${new Date().toISOString()}

export const products = ${JSON.stringify(products, null, 4)};

export const categories = [
    'Performance Tuning',
    'Engine Components',
    'Suspension',
    'Brake Systems',
    'Exhaust Systems',
    'Exterior',
    'Interior',
    'Wheels & Tires',
    'Electronics',
    'Custom Fabrication'
];

export const brands = [...new Set(products.map(p => p.brand))];

export default products;
`;
    
    return fileContent;
};

/**
 * Writes updated product database to file
 */
export const writeProductDatabaseFile = async (products, filePath) => {
    try {
        const content = generateDatabaseFile(products);
        
        // In production, use fs.writeFileSync
        console.log(`üíæ Writing ${products.length} products to database file (${content.length} chars)...`);
        console.log(`   File: ${filePath}`);
        
        // Mock file write
        await new Promise(resolve => setTimeout(resolve, 500));
        
        console.log(`‚úÖ Database file updated successfully!`);
        return true;
    } catch (error) {
        console.error(`‚ùå Error writing database file:`, error.message);
        return false;
    }
};

/**
 * Validates product data before syncing
 */
export const validateProduct = (product) => {
    const required = ['id', 'title', 'price', 'category'];
    const missing = required.filter(field => !product[field]);
    
    if (missing.length > 0) {
        console.warn(`‚ö†Ô∏è  Product validation failed: missing ${missing.join(', ')}`);
        return false;
    }
    
    return true;
};

/**
 * Removes discontinued products from database
 */
export const removeDiscontinuedProducts = (currentProducts, activeProductIds) => {
    const filtered = currentProducts.filter(p => activeProductIds.includes(p.id));
    const removed = currentProducts.length - filtered.length;
    
    console.log(`üóëÔ∏è  Removed ${removed} discontinued products`);
    
    return filtered;
};

/**
 * Full sync operation - scrape, download images, update database
 */
export const performFullSync = async () => {
    console.log(`\n${'='.repeat(60)}`);
    console.log(`üöÄ VSSPEED GLOBAL - FULL PRODUCT SYNC STARTED`);
    console.log(`   ${new Date().toLocaleString()}`);
    console.log(`${'='.repeat(60)}\n`);
    
    try {
        // Import scraper and image pipeline
        const { scrapeAllSuppliers } = await import('./supplier-scraper.js');
        const { downloadAllProductImages } = await import('./image-pipeline.js');
        
        // Step 1: Scrape products from all suppliers
        console.log(`\nüìã STEP 1: Scraping products from suppliers...`);
        const scrapedProducts = await scrapeAllSuppliers(25); // 25 per supplier
        
        // Step 2: Download product images
        console.log(`\nüìã STEP 2: Downloading product images...`);
        const productsWithImages = await downloadAllProductImages(scrapedProducts);
        
        // Step 3: Validate products
        console.log(`\nüìã STEP 3: Validating product data...`);
        const validProducts = productsWithImages.filter(validateProduct);
        console.log(`   ${validProducts.length}/${productsWithImages.length} products validated`);
        
        // Step 4: Sync to database
        console.log(`\nüìã STEP 4: Syncing to product database...`);
        const { results, updatedDatabase } = syncProductsToDatabase(validProducts);
        
        // Step 5: Write to file
        console.log(`\nüìã STEP 5: Writing database file...`);
        const dbPath = 'src/data/productDatabase.js';
        await writeProductDatabaseFile(updatedDatabase, dbPath);
        
        console.log(`\n${'='.repeat(60)}`);
        console.log(`‚úÖ FULL SYNC COMPLETE!`);
        console.log(`   Products Added: ${results.added}`);
        console.log(`   Products Updated: ${results.updated}`);
        console.log(`   Total Products: ${results.newDatabaseSize}`);
        console.log(`${'='.repeat(60)}\n`);
        
        return { success: true, results };
        
    } catch (error) {
        console.error(`\n‚ùå SYNC FAILED:`, error.message);
        return { success: false, error: error.message };
    }
};

export default {
    syncProductsToDatabase,
    generateDatabaseFile,
    writeProductDatabaseFile,
    validateProduct,
    removeDiscontinuedProducts,
    performFullSync
};
